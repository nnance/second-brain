---
phase: 02-graceful-lifecycle
plan: 03
type: execute
depends_on: ["02-01", "02-02"]
files_modified: [src/sessions/lifecycle.test.ts]
---

<objective>
Add integration tests verifying the complete lifecycle: startup restores sessions, shutdown preserves them.

Purpose: Prove sessions survive process restarts.
Output: Tests that verify startup/shutdown lifecycle works correctly.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-graceful-lifecycle/02-01-SUMMARY.md
@.planning/phases/02-graceful-lifecycle/02-02-SUMMARY.md
@src/index.ts
@src/sessions/store.ts
@src/sessions/file-store.ts
@src/sessions/store.test.ts

**Tech stack:** Node.js native test runner (`node:test`), `assert` module
**Testing patterns:**
- Co-located test files (*.test.ts)
- Use temp directories for file tests
- `before()`/`after()` for setup/cleanup
- Descriptive test names starting with "should"
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lifecycle integration tests</name>
  <files>src/sessions/lifecycle.test.ts</files>
  <action>
Create a new test file for lifecycle integration tests:

```typescript
import { describe, it, before, after, beforeEach } from "node:test";
import assert from "node:assert";
import {
  initSessionStore,
  createSession,
  getSession,
  clearAllSessions
} from "./store.js";
import { waitForPendingSave, setStorePath } from "./file-store.js";
import { unlink } from "node:fs/promises";

const TEST_STORE_PATH = "/tmp/lifecycle-test-sessions.json";

describe("lifecycle", () => {
  before(() => {
    // Set test store path
    setStorePath(TEST_STORE_PATH);
  });

  after(async () => {
    // Cleanup
    try {
      await unlink(TEST_STORE_PATH);
    } catch {}
  });

  beforeEach(async () => {
    // Clear store between tests
    clearAllSessions();
    await waitForPendingSave();
    try {
      await unlink(TEST_STORE_PATH);
    } catch {}
  });

  it("should restore sessions after simulated restart", async () => {
    // Create a session
    const session = createSession("test-sender-lifecycle");
    assert.ok(session);

    // Wait for save to complete
    await waitForPendingSave();

    // Simulate restart: clear in-memory state
    clearAllSessions();
    await waitForPendingSave();

    // Verify session is gone from memory
    assert.strictEqual(getSession("test-sender-lifecycle"), undefined);

    // Simulate startup: reinitialize from disk
    await initSessionStore();

    // Verify session restored
    const restored = getSession("test-sender-lifecycle");
    assert.ok(restored, "Session should be restored from disk");
    assert.strictEqual(restored.senderId, "test-sender-lifecycle");
  });

  it("should preserve session data through restart cycle", async () => {
    // Create session with specific data
    createSession("data-test");
    const { updateSession } = await import("./store.js");
    updateSession("data-test", {
      sdkSessionId: "sdk-123",
      pendingInput: "test input"
    });

    await waitForPendingSave();

    // Simulate restart
    clearAllSessions();
    await initSessionStore();

    // Verify all data restored
    const restored = getSession("data-test");
    assert.ok(restored);
    assert.strictEqual(restored.sdkSessionId, "sdk-123");
    assert.strictEqual(restored.pendingInput, "test input");
  });

  it("should handle empty store on first startup", async () => {
    // Ensure no store file exists
    try {
      await unlink(TEST_STORE_PATH);
    } catch {}

    // Initialize should not throw
    await initSessionStore();

    // Should have no sessions
    const { getAllSessions } = await import("./store.js");
    assert.strictEqual(getAllSessions().length, 0);
  });
});
```

**Note:** The test uses `setStorePath()` which needs to be added to file-store.ts to allow test configuration. Add this as part of the task.
  </action>
  <verify>`npm test` passes with new lifecycle tests</verify>
  <done>
- lifecycle.test.ts created with integration tests
- setStorePath() added to file-store.ts for test configuration
- All tests pass
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] `npm test` passes all tests including new lifecycle tests
- [ ] `npm run lint` passes
</verification>

<success_criteria>
- Lifecycle integration tests exist and pass
- Tests verify session restoration after simulated restart
- Tests verify data preservation through restart cycle
- Tests handle empty store edge case
</success_criteria>

<output>
After completion, create `.planning/phases/02-graceful-lifecycle/02-03-SUMMARY.md`
</output>
