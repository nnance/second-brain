---
phase: 02-graceful-lifecycle
plan: 02
type: execute
depends_on: []
files_modified: [src/index.ts, src/sessions/file-store.ts]
---

<objective>
Implement graceful shutdown that ensures all pending session saves complete before exit.

Purpose: Fire-and-forget saves from Phase 1 may be in-flight when SIGTERM/SIGINT arrives. We must wait for them to complete to prevent data loss.
Output: Shutdown handler waits for pending saves before process.exit().
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-session-persistence/01-01-SUMMARY.md
@src/index.ts
@src/sessions/store.ts
@src/sessions/file-store.ts

**Tech stack:** Node.js 20+, TypeScript, ES modules
**Established patterns:**
- Fire-and-forget async saves (from Phase 1)
- Pino structured logging

**Current shutdown behavior:**
```typescript
const shutdown = async () => {
  logger.info("Shutting down...");
  stopTimeoutChecker();
  await stopListener();
  process.exit(0);
};
```

This doesn't wait for pending fire-and-forget saves to complete.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pending save tracking to file-store</name>
  <files>src/sessions/file-store.ts</files>
  <action>
Add a mechanism to track and wait for pending saves:

1. Create a `pendingSave` variable to hold the current save promise (if any)
2. Modify `saveSessions()` to store its promise in `pendingSave`
3. Export `waitForPendingSave(): Promise<void>` that awaits the pending promise

```typescript
let pendingSave: Promise<void> | null = null;

export async function saveSessions(sessions: Map<string, Session>): Promise<void> {
  const saveOp = async () => {
    // ... existing save logic ...
  };

  pendingSave = saveOp();
  await pendingSave;
  pendingSave = null;
}

export async function waitForPendingSave(): Promise<void> {
  if (pendingSave) {
    await pendingSave;
  }
}
```

Note: Since saves are fire-and-forget, there's at most one in-flight at a time per call site. This is sufficient for graceful shutdown.
  </action>
  <verify>`npm run build` passes</verify>
  <done>
- pendingSave tracking variable added
- waitForPendingSave() exported
- Build passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Update shutdown to wait for pending saves</name>
  <files>src/index.ts</files>
  <action>
Modify the shutdown handler to wait for pending saves:

1. Import `waitForPendingSave` from `./sessions/file-store.js`
2. In shutdown handler, call `await waitForPendingSave()` before exit

```typescript
import { waitForPendingSave } from "./sessions/file-store.js";

const shutdown = async () => {
  logger.info("Shutting down...");
  stopTimeoutChecker();
  await stopListener();

  // Wait for any pending session saves to complete
  logger.info("Waiting for pending saves...");
  await waitForPendingSave();

  logger.info("Shutdown complete");
  process.exit(0);
};
```

This ensures no session data is lost on shutdown.
  </action>
  <verify>
1. `npm run build` passes
2. Code review: shutdown awaits waitForPendingSave()
  </verify>
  <done>
- waitForPendingSave imported
- shutdown handler waits for pending saves
- Build passes
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] `npm run lint` passes
- [ ] Shutdown handler includes await waitForPendingSave()
</verification>

<success_criteria>
- Pending save tracking implemented in file-store
- Shutdown waits for pending saves before exit
- No data loss on graceful shutdown
</success_criteria>

<output>
After completion, create `.planning/phases/02-graceful-lifecycle/02-02-SUMMARY.md`
</output>
