# Codebase Structure

**Analysis Date:** 2026-01-13

## Directory Layout

```
second-brain/
├── src/                    # Source code
│   ├── agent/             # Agent layer (Claude SDK)
│   ├── messages/          # iMessage integration
│   ├── sessions/          # Session management
│   ├── tools/             # MCP tool implementations
│   ├── vault/             # Legacy vault helpers
│   ├── scripts/           # CLI scripts
│   ├── index.ts           # Main entry point
│   ├── config.ts          # Configuration loading
│   └── logger.ts          # Pino logger setup
├── specs/                  # Ticket specifications
├── .planning/             # Planning documents
│   └── codebase/          # Codebase analysis docs
├── dist/                   # Compiled output (gitignored)
├── package.json           # Project manifest
├── tsconfig.json          # TypeScript config
├── biome.json             # Linter/formatter config
├── .env.example           # Environment template
├── CLAUDE.md              # Claude Code instructions
└── README.md              # User documentation
```

## Directory Purposes

**src/agent/**
- Purpose: Claude Agent SDK integration and decision engine
- Contains: SDK client, query runner, MCP server, system prompt
- Key files: `client.ts` (SDK exports), `runner.ts` (query execution), `mcp-server.ts` (tool definitions), `system-prompt.ts` (agent instructions)
- Subdirectories: None

**src/messages/**
- Purpose: iMessage capture and event handling
- Contains: Listener module using @photon-ai/imessage-kit
- Key files: `listener.ts` (iMessage watcher)
- Subdirectories: None

**src/sessions/**
- Purpose: Multi-turn conversation state management
- Contains: Session store, timeout handling
- Key files: `store.ts` (in-memory session CRUD), `timeout.ts` (session expiration)
- Subdirectories: None

**src/tools/**
- Purpose: MCP tool implementations invoked by agent
- Contains: 5 tool handlers with Zod schemas
- Key files: `vault-write.ts`, `vault-read.ts`, `vault-list.ts`, `log-interaction.ts`, `send-message.ts`
- Subdirectories: None

**src/vault/**
- Purpose: Legacy vault helpers (deprecated, superseded by tools/)
- Contains: Old writer and interaction log implementations
- Key files: `writer.ts`, `interaction-log.ts`
- Subdirectories: None
- Note: Consider removal after confirming no active usage

**src/scripts/**
- Purpose: CLI utility scripts
- Contains: Vault initialization
- Key files: `init-vault.ts` (creates vault folder structure)
- Subdirectories: None

**specs/**
- Purpose: Implementation ticket specifications
- Contains: Phase-based ticket markdown files
- Key files: Phase 1-5 ticket specs
- Subdirectories: None

## Key File Locations

**Entry Points:**
- `src/index.ts` - Main application entry, orchestrates all layers
- `src/scripts/init-vault.ts` - Vault folder initialization script

**Configuration:**
- `tsconfig.json` - TypeScript compiler options
- `biome.json` - Linting and formatting rules
- `.env.example` - Environment variable template
- `src/config.ts` - Runtime configuration loading

**Core Logic:**
- `src/agent/runner.ts` - Agent query execution
- `src/agent/mcp-server.ts` - MCP tool definitions
- `src/agent/system-prompt.ts` - Agent decision instructions
- `src/sessions/store.ts` - Session state management

**Testing:**
- `src/**/*.test.ts` - Co-located test files
- Test files alongside source (e.g., `vault-write.test.ts` next to `vault-write.ts`)

**Documentation:**
- `README.md` - User-facing documentation
- `CLAUDE.md` - Claude Code instructions for this repo

## Naming Conventions

**Files:**
- kebab-case.ts for all source files (`vault-write.ts`, `mcp-server.ts`)
- *.test.ts suffix for test files
- PascalCase for vault folders (Tasks, Ideas, Reference)

**Directories:**
- kebab-case for source directories
- Singular names for feature modules (`agent`, `session` would be `sessions`)

**Special Patterns:**
- Test files co-located with source
- No index.ts barrel files (direct imports)

## Where to Add New Code

**New Tool:**
- Implementation: `src/tools/{tool-name}.ts`
- Tests: `src/tools/{tool-name}.test.ts`
- Registration: Add to `src/agent/mcp-server.ts`

**New Agent Feature:**
- Implementation: `src/agent/` directory
- System prompt updates: `src/agent/system-prompt.ts`
- Tests: Co-located `.test.ts` file

**New Session Feature:**
- Implementation: `src/sessions/` directory
- Tests: Co-located `.test.ts` file

**Utilities:**
- Currently: Duplicated in each module (technical debt)
- Recommended: Create `src/utils/` directory for shared helpers

## Special Directories

**dist/**
- Purpose: TypeScript compilation output
- Source: Generated by `npm run build`
- Committed: No (in .gitignore)

**.planning/**
- Purpose: Project planning and codebase analysis documents
- Source: Generated by GSD commands
- Committed: Yes

**node_modules/**
- Purpose: NPM dependencies
- Source: Generated by `npm install`
- Committed: No (in .gitignore)

---

*Structure analysis: 2026-01-13*
*Update when directory structure changes*
